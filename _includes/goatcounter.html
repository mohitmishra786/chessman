<script data-goatcounter="https://{{ site.analytics.goatcounter.id }}.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

{% if site.pageviews.provider == "goatcounter" %}
<script>
// GoatCounter pageviews implementation (inspired by Chirpy theme)
// This approach avoids CSP issues and provides reliable view counts

document.addEventListener('DOMContentLoaded', function() {
    // Configuration from Jekyll
    const goatcounterCode = '{{ site.pageviews.goatcounter.code }}';
    
    // Find all elements that should display pageviews
    const pageviewElements = document.querySelectorAll('.goatcounter-views');
    
    if (pageviewElements.length === 0) return;
    
    // Function to fetch pageviews for a specific path
    function fetchPageviews(path, element) {
        // Clean path - remove .html extension if present
        let cleanPath = path;
        if (cleanPath.endsWith('.html')) {
            cleanPath = cleanPath.slice(0, -5);
        }
        
        // GoatCounter counter endpoint (JSON API)
        const apiUrl = `https://${goatcounterCode}.goatcounter.com/counter${encodeURIComponent(cleanPath)}.json`;
        
        fetch(apiUrl)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status === 404) {
                    // Path not found, might be new page
                    return { count: '0' };
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            })
            .then(data => {
                const count = data.count || '0';
                element.textContent = count;
                element.title = `${count} views`;
            })
            .catch(error => {
                console.debug('GoatCounter pageview fetch failed:', error.message);
                // Show fallback
                element.textContent = 'â€”';
                element.title = 'Views: Data temporarily unavailable';
            });
    }
    
    // Process each pageview element
    pageviewElements.forEach(element => {
        const path = element.getAttribute('data-goatcounter-path') || 
                    element.getAttribute('data-path') || 
                    window.location.pathname;
        
        // Set loading state
        element.textContent = '...';
        element.title = 'Loading view count...';
        
        // Fetch pageviews with a small delay to avoid rate limiting
        setTimeout(() => {
            fetchPageviews(path, element);
        }, Math.random() * 1000); // Random delay up to 1 second
    });
});

// Console message for debugging
console.log('GoatCounter pageviews loaded. Site: {{ site.pageviews.goatcounter.code }}');
</script>
{% endif %} 